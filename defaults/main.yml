---

promtail_enabled: true
promtail_identifier: promtail

promtail_hostname: ''
promtail_path_prefix: '/'

promtail_uid: ''
promtail_gid: ''

promtail_base_path: "/{{ promtail_identifier }}"
promtail_config_path: "{{ promtail_base_path }}/config"
promtail_data_path: "{{ promtail_base_path }}/data"

promtail_systemd_required_services_list: "{{ promtail_systemd_required_services_list_default + promtail_systemd_required_services_list_auto + promtail_systemd_required_services_list_custom }}"
promtail_systemd_required_services_list_default: ['docker.service']
promtail_systemd_required_services_list_auto: []
promtail_systemd_required_services_list_custom: []

promtail_version: 2.9.2

promtail_container_image: "{{ promtail_container_image_registry_prefix }}grafana/promtail:{{ promtail_container_image_tag }}"
promtail_container_image_registry_prefix: docker.io/
promtail_container_image_tag: "{{ promtail_version }}"
promtail_container_image_force_pull: "{{ promtail_container_image.endswith(':latest') }}"

promtail_container_network: '{{ promtail_identifier }}'

# A list of additional container networks that the container would be connected to.
# The role does not create these networks, so make sure they already exist.
promtail_container_additional_networks: "{{ promtail_container_additional_networks_auto + promtail_container_additional_networks_custom }}"
promtail_container_additional_networks_auto: []
promtail_container_additional_networks_custom: []

# Controls whether the promtail container exposes its HTTP port (promtail_config_server_http_port).
#
# Takes an "<ip>:<port>" or "<port>" value (e.g. "127.0.0.1:9080"), or empty string to not expose.
promtail_container_http_host_bind_port: ""

# Controls whether the promtail container exposes its GRPC port (promtail_config_server_grpc_port).
#
# Takes an "<ip>:<port>" or "<port>" value (e.g. "127.0.0.1:9081"), or empty string to not expose.
promtail_container_grpc_host_bind_port: ""

# The ports promtail will use for http/grpc inside the container
promtail_config_server_http_port: 9080
promtail_config_server_grpc_port: 9081

# promtail_container_labels_traefik_enabled controls whether labels to assist a Traefik reverse-proxy will be attached to the container.
# See `../templates/labels.j2` for details.
#
# To inject your own other container labels, see `promtail_container_labels_additional_labels`.
promtail_container_labels_traefik_enabled: false
promtail_container_labels_traefik_docker_network: "{{ promtail_container_network }}"
promtail_container_labels_traefik_hostname: "{{ promtail_hostname }}"
# The path prefix must either be `/` or not end with a slash (e.g. `/promtail`).
promtail_container_labels_traefik_path_prefix: "{{ promtail_path_prefix }}"
promtail_container_labels_traefik_rule: "Host(`{{ promtail_container_labels_traefik_hostname }}`){% if promtail_container_labels_traefik_path_prefix != '/' %} && PathPrefix(`{{ promtail_container_labels_traefik_path_prefix }}`){% endif %}"
promtail_container_labels_traefik_priority: 0
promtail_container_labels_traefik_entrypoints: web-secure
promtail_container_labels_traefik_tls: "{{ promtail_container_labels_traefik_entrypoints != 'web' }}"
promtail_container_labels_traefik_tls_certResolver: default  # noqa var-naming
promtail_container_labels_middleware_basic_auth_enabled: false
# See: https://doc.traefik.io/traefik/middlewares/http/basicauth/#users
promtail_container_labels_middleware_basic_auth_users: ''

# promtail_container_labels_additional_labels contains a multiline string with additional labels to add to the container label file.
# See `../templates/labels.j2` for details.
#
# Example:
# promtail_container_labels_additional_labels: |
#   my.label=1
#   another.label="here"
promtail_container_labels_additional_labels: ''

# Controls which additional headers to attach to all HTTP requests.
# To add your own custom request headers, use `promtail_container_labels_traefik_additional_response_headers_custom`
promtail_container_labels_traefik_additional_request_headers: "{{ promtail_container_labels_traefik_additional_request_headers_auto | combine(promtail_container_labels_traefik_additional_request_headers_custom) }}"
promtail_container_labels_traefik_additional_request_headers_auto: {}
promtail_container_labels_traefik_additional_request_headers_custom: {}

# Controls which additional headers to attach to all HTTP responses.
# To add your own custom response headers, use `promtail_container_labels_traefik_additional_response_headers_custom`
promtail_container_labels_traefik_additional_response_headers: "{{ promtail_container_labels_traefik_additional_response_headers_auto | combine(promtail_container_labels_traefik_additional_response_headers_custom) }}"
promtail_container_labels_traefik_additional_response_headers_auto: |
  {{
    {}
    | combine ({'X-XSS-Protection': promtail_http_header_xss_protection} if promtail_http_header_xss_protection else {})
    | combine ({'X-Frame-Options': promtail_http_header_frame_options} if promtail_http_header_frame_options else {})
    | combine ({'X-Content-Type-Options': promtail_http_header_content_type_options} if promtail_http_header_content_type_options else {})
    | combine ({'Content-Security-Policy': promtail_http_header_content_security_policy} if promtail_http_header_content_security_policy else {})
    | combine ({'Permission-Policy': promtail_http_header_content_permission_policy} if promtail_http_header_content_permission_policy else {})
    | combine ({'Strict-Transport-Security': promtail_http_header_strict_transport_security} if promtail_http_header_strict_transport_security and promtail_container_labels_traefik_tls else {})
  }}
promtail_container_labels_traefik_additional_response_headers_custom: {}

# Specifies the size (in MB) of the tmpfs /tmp directory
promtail_tmpfs_size_mb: 100

# A list of additional "mounts" to be mounted in the container.
# Contains definition objects like this:
# promtail_container_additional_mounts:
# - "type=bind|volume|tmpfs,source=/outside,target=/inside,readonly,bind-propagation=slave"
promtail_container_additional_mounts: "{{ promtail_container_additional_mounts_default + promtail_container_additional_mounts_auto + promtail_container_additional_mounts_custom }}"
promtail_container_additional_mounts_default: |
  {{
    (promtail_journald_scraper_container_additional_volumes if promtail_journald_scraper_enabled else [])
    +
    (promtail_varlog_scraper_container_additional_volumes if promtail_varlog_scraper_enabled else [])
  }}
promtail_container_additional_mounts_auto: []
promtail_container_additional_mounts_custom: []

# For a more advanced customization, you can extend the default (see `promtail_configuration_extension_yaml`)
# or completely replace this variable with your own template.
promtail_configuration_yaml: "{{ lookup('template', 'templates/config.yml.j2') }}"

promtail_configuration_extension_yaml: |
  # This configuration extends the default starting configuration (`promtail_configuration_yaml`).
  #
  # You can override individual variables from the default configuration, or introduce new ones.
  #
  # If you need something more special, you can take full control by
  # completely redefining `promtail_configuration_yaml`.
promtail_configuration_extension: "{{ promtail_configuration_extension_yaml | from_yaml if promtail_configuration_extension_yaml | from_yaml is mapping else {} }}"

# Holds the final configuration (a combination of the default and its extension).
# You most likely don't need to touch this variable. Instead, see `promtail_configuration_yaml`.
promtail_configuration: "{{ promtail_configuration_yaml | from_yaml | combine(promtail_configuration_extension, recursive=True) }}"

# Controls the scrape_configs configuration parameter
promtail_config_scrape_configs: "{{ '\n'.join((promtail_config_scrape_configs_default, promtail_config_scrape_configs_auto, promtail_config_scrape_configs_custom)) }}"

promtail_config_scrape_configs_default: |
  {{ (promtail_journald_scraper_config + '\n' if promtail_journald_scraper_enabled else '') }}
  {{ (promtail_varlog_scraper_config if promtail_varlog_scraper_enabled else '') }}

promtail_config_scrape_configs_auto: ''
promtail_config_scrape_configs_custom: ''

########################################################################
#                                                                      #
# journald scraper                                                     #
#                                                                      #
########################################################################

promtail_journald_scraper_enabled: true

promtail_journald_scraper_container_additional_volumes:
  - "type=bind,source=/var/log/journal,target=/var-log-journal,readonly"
  - "type=bind,source=/etc/machine-id,target=/etc/machine-id,readonly"

promtail_journald_scraper_config: >-
  - job_name: journal
    journal:
      json: false
      max_age: 12h
      path: /var-log-journal
      labels:
        job: systemd-journal
    relabel_configs:
      - source_labels: ["__journal__systemd_unit"]
        target_label: "unit"
      - source_labels: ["__journal__hostname"]
        target_label: host
      - source_labels: ["__journal_priority_keyword"]
        target_label: level
      - source_labels: ["__journal_syslog_identifier"]
        target_label: syslog_identifier
    pipeline_stages:
      - match:
          selector:  '{unit="{{ promtail_identifier }}.service"}'
          action: drop

########################################################################
#                                                                      #
# /journald scraper                                                    #
#                                                                      #
########################################################################


########################################################################
#                                                                      #
# varlog scraper                                                       #
#                                                                      #
########################################################################

promtail_varlog_scraper_enabled: true

promtail_varlog_scraper_container_additional_volumes:
  - "type=bind,source=/var/log,target=/var-log,readonly"

promtail_varlog_scraper_config: >-
  - job_name: varlog
    static_configs:
    - targets:
      - localhost
      labels:
        __path__: /var-log/**/*log
        job: varlog

########################################################################
#                                                                      #
# /varlog scraper                                                      #
#                                                                      #
########################################################################

# Clients config
# A client definition should contain a `url` field. Example:
# promtail_config_clients_custom:
#   # Note the double /loki/loki.
#   # This assumes Loki is installed at a `/loki` path-prefix.
#   - url: https://mash.example.com/loki/loki/api/v1/push
promtail_config_clients: "{{ promtail_config_clients_auto + promtail_config_clients_custom }}"
promtail_config_clients_auto: []
promtail_config_clients_custom: []

# Configures the positions.filename parameter. This is an in-container path.
promtail_config_positions_filename: /data/positions.yml
